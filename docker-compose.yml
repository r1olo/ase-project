version: "3.9"

services:
  nginx:
    build:
      context: .
      dockerfile: src/api_gateway/Dockerfile
    environment:
      AUTH_URL: http://auth:5000
      PLAYERS_URL: http://players:5000
      MATCHMAKING_URL: http://matchmaking:5000
      CATALOGUE_URL: http://catalogue:5000
      GAME_ENGINE_URL: http://game-engine:5000
    depends_on:
      - auth
      - players
      - catalogue
      - matchmaking
      - game-engine
    ports:
      - "80:80"

  auth:
    build:
      context: .
      dockerfile: src/auth/Dockerfile
    environment:
      FLASK_APP: auth.app
      AUTH_DATABASE_URL: postgresql+psycopg://auth_user:auth_password@auth-db:5432/auth_db
      AUTH_REDIS_URL: redis://auth-redis:6379/0
      AUTH_PUBLIC_KEY: /run/secrets/jwt_public_key
      AUTH_PRIVATE_KEY: /run/secrets/jwt_private_key
    depends_on:
      auth-db:
        condition: service_healthy
      auth-redis:
        condition: service_started
    expose:
      - "5000"
    secrets:
      - jwt_private_key
      - jwt_public_key

  auth-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: auth_user
      POSTGRES_PASSWORD: auth_password
    volumes:
      - auth-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U auth_user -d auth_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  auth-redis:
    image: redis:7-alpine
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    volumes:
      - auth-redis-data:/data

  catalogue:
    build:
      context: .
      dockerfile: src/catalogue/Dockerfile
    environment:
      CATALOGUE_DATABASE_URL: postgresql+psycopg://catalogue_user:catalogue_password@catalogue-db:5432/catalogue_db
      AUTH_PUBLIC_KEY: /run/secrets/jwt_public_key
    depends_on:
      catalogue-db:
        condition: service_healthy
    expose:
      - "5000"
    secrets:
      - jwt_public_key

  catalogue-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: catalogue_db
      POSTGRES_USER: catalogue_user
      POSTGRES_PASSWORD: catalogue_password
    volumes:
      - catalogue-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U catalogue_user -d catalogue_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  players:
    build:
      context: .
      dockerfile: src/players/Dockerfile
    environment:
      PLAYERS_DATABASE_URL: postgresql+psycopg://players_user:players_password@players-db:5432/players_db
      AUTH_PUBLIC_KEY: /run/secrets/jwt_public_key
    depends_on:
      players-db:
        condition: service_healthy
    expose:
      - "5000"
    secrets:
      - jwt_public_key

  players-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: players_db
      POSTGRES_USER: players_user
      POSTGRES_PASSWORD: players_password
    volumes:
      - players-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U players_user -d players_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  game-engine:
    build:
      context: .
      dockerfile: src/game_engine/Dockerfile
    environment:
      CATALOGUE_URL: http://catalogue:5000
      GAME_ENGINE_DATABASE_URL: postgresql+psycopg://engine_user:engine_password@game-engine-db:5432/game_engine_db
      AUTH_PUBLIC_KEY: /run/secrets/jwt_public_key
    depends_on:
      game-engine-db:
        condition: service_healthy
    expose:
      - "5000"
    secrets:
      - jwt_public_key

  game-engine-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: game_engine_db
      POSTGRES_USER: engine_user
      POSTGRES_PASSWORD: engine_password
    volumes:
      - game-engine-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U engine_user -d game_engine_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  matchmaking:
    build:
      context: .
      dockerfile: src/matchmaking/Dockerfile
    environment:
      GAME_ENGINE_URL: http://game-engine:5000
      MATCHMAKING_REDIS_URL: redis://matchmaking-redis:6379/0
      MATCHMAKING_QUEUE_KEY: matchmaking:queue
      MATCHMAKING_MAX_QUEUE_SIZE: 500
      AUTH_PUBLIC_KEY: /run/secrets/jwt_public_key
    depends_on:
      matchmaking-redis:
        condition: service_started
      game-engine:
        condition: service_started
    expose:
      - "5000"
    secrets:
      - jwt_public_key

  matchmaking-redis:
    image: redis:7-alpine
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    volumes:
      - matchmaking-redis-data:/data

volumes:
  auth-db-data:
  auth-redis-data:
  catalogue-db-data:
  players-db-data:
  game-engine-db-data:
  matchmaking-redis-data:

secrets:
  jwt_private_key:
    file: ./secrets/jwtRS256.key
  jwt_public_key:
    file: ./secrets/jwtRS256.key.pub
