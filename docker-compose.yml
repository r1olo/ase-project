services:
  nginx:
    build:
      context: .
      dockerfile: src/api_gateway/Dockerfile
    environment:
      AUTH_URL: https://auth:5000
      PLAYERS_URL: https://players:5000
      MATCHMAKING_URL: https://matchmaking:5000
      CATALOGUE_URL: https://catalogue:5000
      GAME_ENGINE_URL: https://game-engine:5000
    depends_on:
      - auth
      - players
      - catalogue
      - matchmaking
      - game-engine
    ports:
      - "443:443"
    secrets:
      - nginx.crt
      - nginx.key

  auth:
    build:
      context: .
      dockerfile: src/auth/Dockerfile
    environment:
      FLASK_APP: auth.app
      AUTH_DATABASE_URL: postgresql+psycopg://auth_user:auth_password@auth-db:5432/auth_db?sslmode=require
      AUTH_REDIS_URL: rediss://auth-redis:6379/0?ssl_cert_reqs=none
      AUTH_PUBLIC_KEY: /run/secrets/jwt_public_key
      AUTH_PRIVATE_KEY: /run/secrets/jwt_private_key
      AUTH_ENCRYPTION_KEY: /run/secrets/auth_db_encryption_key
    depends_on:
      auth-db:
        condition: service_healthy
      auth-redis:
        condition: service_started
    expose:
      - "5000"
    secrets:
      - jwt_private_key
      - jwt_public_key
      - auth.crt
      - auth.key
      - auth_db_encryption_key

  auth-db:
    image: postgres-ssl
    build:
      context: .
      dockerfile: docker/Dockerfile.postgres
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: auth_user
      POSTGRES_PASSWORD: auth_password
      POSTGRES_CERT: /run/secrets/auth-db.crt
      POSTGRES_KEY: /run/secrets/auth-db.key
    volumes:
      - auth-db-data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U auth_user -d auth_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    secrets:
      - auth-db.crt
      - auth-db.key

  auth-redis:
    image: redis-ssl
    build:
      context: .
      dockerfile: docker/Dockerfile.redis
    environment:
      TLS_CERT_SECRET: /run/secrets/auth-db.crt
      TLS_KEY_SECRET: /run/secrets/auth-db.key
    volumes:
      - auth-redis-data:/data
    secrets:
      - auth-db.crt
      - auth-db.key

  catalogue:
    build:
      context: .
      dockerfile: src/catalogue/Dockerfile
    environment:
      CATALOGUE_DATABASE_URL: postgresql+psycopg://catalogue_user:catalogue_password@catalogue-db:5432/catalogue_db?sslmode=require
      AUTH_PUBLIC_KEY: /run/secrets/jwt_public_key
    depends_on:
      catalogue-db:
        condition: service_healthy
    expose:
      - "5000"
    secrets:
      - jwt_public_key
      - catalogue.crt
      - catalogue.key

  catalogue-db:
    image: postgres-ssl
    environment:
      POSTGRES_DB: catalogue_db
      POSTGRES_USER: catalogue_user
      POSTGRES_PASSWORD: catalogue_password
      POSTGRES_CERT: /run/secrets/catalogue-db.crt
      POSTGRES_KEY: /run/secrets/catalogue-db.key
    volumes:
      - catalogue-db-data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U catalogue_user -d catalogue_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    secrets:
      - catalogue-db.crt
      - catalogue-db.key

  players:
    build:
      context: .
      dockerfile: src/players/Dockerfile
    environment:
      PLAYERS_DATABASE_URL: postgresql+psycopg://players_user:players_password@players-db:5432/players_db?sslmode=require
      AUTH_PUBLIC_KEY: /run/secrets/jwt_public_key
    depends_on:
      players-db:
        condition: service_healthy
    expose:
      - "5000"
    secrets:
      - jwt_public_key
      - players.crt
      - players.key

  players-db:
    image: postgres-ssl
    environment:
      POSTGRES_DB: players_db
      POSTGRES_USER: players_user
      POSTGRES_PASSWORD: players_password
      POSTGRES_CERT: /run/secrets/players-db.crt
      POSTGRES_KEY: /run/secrets/players-db.key
    volumes:
      - players-db-data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U players_user -d players_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    secrets:
      - players-db.crt
      - players-db.key

  game-engine:
    build:
      context: .
      dockerfile: src/game_engine/Dockerfile
    environment:
      CATALOGUE_URL: https://catalogue:5000
      PLAYERS_URL: https://players:5000
      GAME_ENGINE_DATABASE_URL: postgresql+psycopg://engine_user:engine_password@game-engine-db:5432/game_engine_db?sslmode=require
      AUTH_PUBLIC_KEY: /run/secrets/jwt_public_key
    depends_on:
      game-engine-db:
        condition: service_healthy
    expose:
      - "5000"
    secrets:
      - jwt_public_key
      - game-engine.crt
      - game-engine.key

  game-engine-db:
    image: postgres-ssl
    environment:
      POSTGRES_DB: game_engine_db
      POSTGRES_USER: engine_user
      POSTGRES_PASSWORD: engine_password
      POSTGRES_CERT: /run/secrets/game-engine-db.crt
      POSTGRES_KEY: /run/secrets/game-engine-db.key
    volumes:
      - game-engine-db-data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U engine_user -d game_engine_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    secrets:
      - game-engine-db.crt
      - game-engine-db.key

  matchmaking:
    build:
      context: .
      dockerfile: src/matchmaking/Dockerfile
    environment:
      GAME_ENGINE_URL: https://game-engine:5000
      MATCHMAKING_REDIS_URL: rediss://matchmaking-redis:6379/0?ssl_cert_reqs=none
      MATCHMAKING_QUEUE_KEY: matchmaking:queue
      MATCHMAKING_MAX_QUEUE_SIZE: 500
      AUTH_PUBLIC_KEY: /run/secrets/jwt_public_key
    depends_on:
      matchmaking-redis:
        condition: service_started
      game-engine:
        condition: service_started
    expose:
      - "5000"
    secrets:
      - jwt_public_key
      - matchmaking.crt
      - matchmaking.key

  matchmaking-redis:
    image: redis-ssl
    environment:
      TLS_CERT_SECRET: /run/secrets/matchmaking-db.crt
      TLS_KEY_SECRET: /run/secrets/matchmaking-db.key
    volumes:
      - matchmaking-redis-data:/data
    secrets:
      - matchmaking-db.crt
      - matchmaking-db.key

volumes:
  auth-db-data:
  auth-redis-data:
  catalogue-db-data:
  players-db-data:
  game-engine-db-data:
  matchmaking-redis-data:

secrets:
  jwt_private_key:
    file: ./secrets/jwtRS256.key
  jwt_public_key:
    file: ./secrets/jwtRS256.key.pub
  nginx.crt:
    file: ./secrets/nginx.crt
  nginx.key:
    file: ./secrets/nginx.key
  auth.crt:
    file: ./secrets/auth.crt
  auth.key:
    file: ./secrets/auth.key
  auth-db.crt:
    file: ./secrets/auth-db.crt
  auth-db.key:
    file: ./secrets/auth-db.key
  players.crt:
    file: ./secrets/players.crt
  players.key:
    file: ./secrets/players.key
  players-db.crt:
    file: ./secrets/players-db.crt
  players-db.key:
    file: ./secrets/players-db.key
  game-engine.crt:
    file: ./secrets/game-engine.crt
  game-engine.key:
    file: ./secrets/game-engine.key
  game-engine-db.crt:
    file: ./secrets/game-engine-db.crt
  game-engine-db.key:
    file: ./secrets/game-engine-db.key
  matchmaking.crt:
    file: ./secrets/matchmaking.crt
  matchmaking.key:
    file: ./secrets/matchmaking.key
  matchmaking-db.crt:
    file: ./secrets/matchmaking-db.crt
  matchmaking-db.key:
    file: ./secrets/matchmaking-db.key
  catalogue.crt:
    file: ./secrets/catalogue.crt
  catalogue.key:
    file: ./secrets/catalogue.key
  catalogue-db.crt:
    file: ./secrets/catalogue-db.crt
  catalogue-db.key:
    file: ./secrets/catalogue-db.key
  auth_db_encryption_key:
    file: ./secrets/auth_db_encryption.key
