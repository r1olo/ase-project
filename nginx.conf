worker_processes  1;

events { worker_connections 1024; }

http {
    resolver 127.0.0.11 ipv6=off;

    server {
        listen 80;
        server_name _;

        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        set $auth_upstream        "${AUTH_URL}";
        set $players_upstream     "${PLAYERS_URL}";
        set $matchmaking_upstream "${MATCHMAKING_URL}";
        set $catalogue_upstream   "${CATALOGUE_URL}";
        set $game_engine_upstream "${GAME_ENGINE_URL}";

        # ---- Auth ----
        location = /register { proxy_pass $auth_upstream$request_uri; }
        location = /login    { proxy_pass $auth_upstream$request_uri; }
        location = /refresh  { proxy_pass $auth_upstream$request_uri; }
        location = /logout   { proxy_pass $auth_upstream$request_uri; }

        # ---- Players ----
        location = /players/me       { proxy_pass $players_upstream$request_uri; }
        location = /players          { proxy_pass $players_upstream$request_uri; }
        location ~ ^/players/[^/]+$  { proxy_pass $players_upstream$request_uri; }
        location = /history          { proxy_pass $players_upstream$request_uri; }
        location ~ ^/history/\d+$    { proxy_pass $players_upstream$request_uri; }

        # ---- Matchmaking ----
        location = /enqueue { proxy_pass $matchmaking_upstream$request_uri; }
        location = /dequeue { proxy_pass $matchmaking_upstream$request_uri; }
        location = /status  { proxy_pass $matchmaking_upstream$request_uri; }

        # ---- Catalogue (excluding /cards/validation) ----
        location = /cards        { proxy_pass $catalogue_upstream$request_uri; }
        location ~ ^/cards/\d+$  { proxy_pass $catalogue_upstream$request_uri; }
        location ^~ /cards/validation { return 404; }

        # ---- Game Engine (/game prefix; excluding /game/matches/create) ----
        location = /leaderboard              { proxy_pass $game_engine_upstream$request_uri; }
        location ~ ^/matches/\d+/deck$       { proxy_pass $game_engine_upstream$request_uri; }
        location ~ ^/matches/\d+/moves$      { proxy_pass $game_engine_upstream$request_uri; }
        location ~ ^/matches/\d+/round$      { proxy_pass $game_engine_upstream$request_uri; }
        location ~ ^/matches/\d+/history$    { proxy_pass $game_engine_upstream$request_uri; }
        location ~ ^/matches/\d+$            { proxy_pass $game_engine_upstream$request_uri; }
        location = /matches/create           { return 404; }

        # ---- Static Images ----
        location /images/ {
            alias /var/www/images/;
            autoindex off;               # optional: disable directory listing
            try_files $uri =404;         # return 404 if file doesn't exist
            access_log off;              # optional: no logs for images

            # Force correct content-types
            types {
                image/png   png;
                image/jpeg  jpg jpeg;
                image/gif   gif;
                image/webp  webp;
                image/svg+xml svg;
            }

            default_type application/octet-stream;  # fallback for unknown extensions
        }

        # ---- Default ----
        location / { return 404; }
    }
}
