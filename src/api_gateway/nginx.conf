worker_processes  32;

events { worker_connections 32; }

http {
    resolver 127.0.0.11 ipv6=off;

    # -------------------------------------
    # HTTP â†’ HTTPS Redirect (disabled)
    # -------------------------------------
    # server {
    #     listen 80;
    #     server_name _;
    #     return 301 https://$host$request_uri;
    # }

    # -------------------------------------
    # HTTPS Server
    # -------------------------------------
    server {
        listen 443 ssl;
        server_name _;

        # TLS Cert + Key from Docker Secrets
        ssl_certificate     /run/secrets/nginx.crt;
        ssl_certificate_key /run/secrets/nginx.key;

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;

        # Common reverse-proxy headers
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;

        # Upstream URLs injected from Docker environment
        set $auth_upstream        "${AUTH_URL}";
        set $players_upstream     "${PLAYERS_URL}";
        set $matchmaking_upstream "${MATCHMAKING_URL}";
        set $catalogue_upstream   "${CATALOGUE_URL}";
        set $game_engine_upstream "${GAME_ENGINE_URL}";

        # ---- Auth ----
        location = /register      { proxy_pass $auth_upstream$request_uri; }
        location = /login         { proxy_pass $auth_upstream$request_uri; }
        location = /refresh       { proxy_pass $auth_upstream$request_uri; }
        location = /logout        { proxy_pass $auth_upstream$request_uri; }

        # ---- Players ----
        # location = /players/me       { proxy_pass $game_engine_upstream$request_uri; }
        # location = /players          { proxy_pass $game_engine_upstream$request_uri; }
        # location ~ ^/players/[^/]+$  { proxy_pass $game_engine_upstream$request_uri; }
        location /players         { proxy_pass $players_upstream$request_uri; }

        # ---- Matchmaking ----
        location = /enqueue       { proxy_pass $matchmaking_upstream$request_uri; }
        location = /dequeue       { proxy_pass $matchmaking_upstream$request_uri; }
        location = /status        { proxy_pass $matchmaking_upstream$request_uri; }

        # ---- Catalogue (excluding /cards/validation) ----
        # location = /cards        { proxy_pass $catalogue_upstream$request_uri; }
        # location ~ ^/cards/\d+$  { proxy_pass $catalogue_upstream$request_uri; }
        location /cards           { proxy_pass $catalogue_upstream$request_uri; }

        # ---- Game Engine ----
        location = /leaderboard   { proxy_pass $game_engine_upstream$request_uri; }
        location /matches         { proxy_pass $game_engine_upstream$request_uri; }
        location /history         { proxy_pass $game_engine_upstream$request_uri; }

        # ---- Static Images ----
        location /images/ {
            alias /var/www/images/;
            autoindex off;
            try_files $uri =404;
            access_log off;

            types {
                image/png   png;
                image/jpeg  jpg jpeg;
                image/gif   gif;
                image/webp  webp;
                image/svg+xml svg;
            }

            default_type application/octet-stream;
        }

        # ---- Default ---- (including /internal)
        location / { return 404; }
    }
}
