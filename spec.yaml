
openapi: 3.1.0
info:
  title: CARUSI Game Platform API
  version: 1.0.0
  summary: REST API for players, authentication, matchmaking, matches, rounds, and card catalogue
  description: |
    This specification models the endpoints and data model described in the slides.
    It is highly extensible and annotated with comments, reusable components, and metadata.
  termsOfService: https://example.com/terms
  contact:
    name: API Support
    url: https://example.com/support
    email: support@example.com
  license:
    name: Apache-2.0
    identifier: Apache-2.0

# Servers can be extended with additional variables (e.g., region, version).
servers:
  - url: https://api.example.com/v1
    description: Production
  - url: https://staging-api.example.com/v1
    description: Staging
  - url: http://localhost:8080/v1
    description: Local

tags:
  # Tag grouping for navigation UIs
  - name: Authentication
    description: Login, registration, and logout flows.
    x-displayName: Auth
  - name: Players
    description: Player profiles, scores, rankings, and match history.
  - name: Matchmaking
    description: Enqueue/dequeue players and check queue status.
  - name: Matches
    description: Create matches, manage rounds, play cards, and handle forfeits.
  - name: Cards
    description: Card catalogue browsing.
  - name: Utilities
    description: Service health and metadata.

x-tagGroups:
  - name: Core
    tags: [Authentication, Players, Matchmaking, Matches, Cards]
  - name: Operations
    tags: [Utilities]

# Common components kept DRY for wide reuse
components:
  securitySchemes:
    # Cookie session or JWT bearer â€” support both to be flexible
    SessionCookie:
      type: apiKey
      in: cookie
      name: sid
      description: Signed HTTP-only secure cookie set by /login
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  headers:
    RequestId:
      description: Correlates requests across services
      schema:
        type: string
    RateLimit-Limit:
      description: The maximum number of requests allowed in the current window
      schema:
        type: integer
    RateLimit-Remaining:
      description: The number of requests left for the time window
      schema:
        type: integer
    RateLimit-Reset:
      description: UTC epoch seconds when the current rate limit window resets
      schema:
        type: integer
  parameters:
    # Reusable path/collection parameters
    PlayerId:
      name: pId
      in: path
      required: true
      schema:
        $ref: '#/components/schemas/Id'
      description: Player identifier
    MatchId:
      name: mId
      in: path
      required: true
      schema:
        $ref: '#/components/schemas/Id'
      description: Match identifier
    RoundId:
      name: rId
      in: path
      required: true
      schema:
        type: integer
        minimum: 1
      description: Round sequence number (1-based)
    PaginationLimit:
      name: limit
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 200
        default: 25
      description: Page size
    PaginationCursor:
      name: cursor
      in: query
      required: false
      schema:
        type: string
      description: Opaque cursor for the next page
    SearchQ:
      name: q
      in: query
      required: false
      schema:
        type: string
      description: Optional free-text search
  responses:
    Problem:
      description: RFC 9457 problem+json response
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/Problem'
    NoContent:
      description: Operation succeeded; no content returned.
  requestBodies:
    # JSON with deck (list of card IDs) to attach to a match
    DeckJson:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/DeckRequest'
          examples:
            example:
              value:
                cardIds: ["card_eco_01", "card_env_07", "card_food_04"]
    PlayCardJson:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/PlayCardRequest'
          examples:
            example:
              value:
                cardId: "card_env_07"
    LoginJson:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/LoginRequest'
          examples:
            example:
              value:
                username: "andrea"
                passwordHash: "base64-sha256(...)"  # per slides: hashed payload
    RegisterJson:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/RegisterRequest'
          examples:
            example:
              value:
                username: "newplayer"
                email: "np@example.com"
                passwordHash: "base64-sha256(...)"

  schemas:
    # Primitive, commonly reused
    Id:
      type: string
      description: Generic string identifier (UUID, ULID, or snowflake)
      examples: ["usr_01h8g...", "match_01he...", "card_eco_01"]
    # Error/Problem details
    Problem:
      type: object
      properties:
        type:
          type: string
          format: uri
        title:
          type: string
        status:
          type: integer
        detail:
          type: string
        instance:
          type: string
          format: uri
        traceId:
          type: string
      required: [title, status]
      additionalProperties: true

    # Core resources from the slides
    Player:
      type: object
      properties:
        id: { $ref: '#/components/schemas/Id' }
        username: { type: string }
        email: { type: string, format: email }
        profilePicture: { type: string, format: uri }
        score: { type: integer, description: "Cached" }
        ranking: { type: integer, description: "Cached" }
        history:
          type: array
          items:
            $ref: '#/components/schemas/MatchSummary'
      required: [id, username]
      description: Player profile, scores, and cached ranking
    PlayerUpdate:
      type: object
      description: Fields allowed to be updated on a player
      properties:
        username: { type: string }
        email: { type: string, format: email }
        profilePicture: { type: string, format: uri }
      additionalProperties: false

    Card:
      type: object
      properties:
        id: { $ref: '#/components/schemas/Id' }
        name: { type: string, description: "Name of the region" }
        image: { type: string, format: uri }
        category:
          type: string
          enum: [economy, food, environment, special, average]
        economy: { type: integer }
        food: { type: integer }
        environment: { type: integer }
        special: { type: integer }
        average: { type: number, format: float, description: "View/derived" }
      required: [id, name, category]

    Match:
      type: object
      properties:
        id: { $ref: '#/components/schemas/Id' }
        player1Id: { $ref: '#/components/schemas/Id' }
        player2Id: { $ref: '#/components/schemas/Id' }
        status:
          type: string
          enum: [queued, active, completed, forfeited, cancelled]
        winnerId:
          anyOf:
            - $ref: '#/components/schemas/Id'
            - type: "null"
        rounds:
          type: array
          items: { $ref: '#/components/schemas/Round' }
      required: [id, player1Id, player2Id, status]

    MatchSummary:
      type: object
      properties:
        id: { $ref: '#/components/schemas/Id' }
        status:
          type: string
          enum: [queued, active, completed, forfeited, cancelled]
        winnerId:
          anyOf:
            - $ref: '#/components/schemas/Id'
            - type: "null"

    Round:
      type: object
      properties:
        id: { type: integer }
        matchId: { $ref: '#/components/schemas/Id' }
        turnNumber: { type: integer, minimum: 1 }
        category:
          type: string
          enum: [economy, food, environment, special, average]
        player1CardId: { $ref: '#/components/schemas/Id' }
        player2CardId: { $ref: '#/components/schemas/Id' }
        winnerId:
          anyOf:
            - $ref: '#/components/schemas/Id'
            - type: "null"
      required: [id, matchId, turnNumber, category]

    DeckRequest:
      type: object
      properties:
        cardIds:
          type: array
          minItems: 1
          items: { $ref: '#/components/schemas/Id' }
      required: [cardIds]

    PlayCardRequest:
      type: object
      properties:
        cardId: { $ref: '#/components/schemas/Id' }
      required: [cardId]

    QueueStatus:
      type: object
      properties:
        inQueue: { type: boolean }
        position: { type: integer, minimum: 0 }
        estimatedWaitSeconds: { type: integer, minimum: 0 }

    LeaderboardEntry:
      type: object
      properties:
        playerId: { $ref: '#/components/schemas/Id' }
        username: { type: string }
        score: { type: integer }
        ranking: { type: integer }

    LoginRequest:
      type: object
      description: Hashed payload per slides
      properties:
        username: { type: string }
        passwordHash: { type: string }
      required: [username, passwordHash]

    RegisterRequest:
      type: object
      properties:
        username: { type: string }
        email: { type: string, format: email }
        passwordHash: { type: string }
      required: [username, email, passwordHash]

  # Reusable example collection responses
  examples:
    CardsPage:
      value:
        data:
          - id: card_env_07
            name: "Cinque Terre"
            image: "https://example.com/ct.jpg"
            category: environment
            environment: 95
            average: 78.2
        nextCursor: "c3VwZXJzZWNyZXQ"


paths:
  # AUTHENTICATION (per slides: POST /login, /register, /logout)
  /login:
    post:
      tags: [Authentication]
      summary: Log in
      description: Sets a secure session cookie or returns a bearer token.
      requestBody:
        $ref: '#/components/requestBodies/LoginJson'
      responses:
        '200':
          description: Logged in
          headers:
            Set-Cookie:
              description: HTTP-only secure session cookie
              schema: { type: string }
          content:
            application/json:
              schema:
                type: object
                properties:
                  token: { type: string, description: "Optional JWT if Bearer is used" }
        '401': { $ref: '#/components/responses/Problem' }

  /register:
    post:
      tags: [Authentication]
      summary: Register a new player
      requestBody:
        $ref: '#/components/requestBodies/RegisterJson'
      responses:
        '201':
          description: Registered
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Player' }
        '409': { $ref: '#/components/responses/Problem' }

  /logout:
    post:
      tags: [Authentication]
      summary: Log out
      responses:
        '204': { $ref: '#/components/responses/NoContent' }

  # PLAYERS
  /players:
    get:
      tags: [Players]
      summary: List players
      parameters:
        - $ref: '#/components/parameters/PaginationLimit'
        - $ref: '#/components/parameters/PaginationCursor'
        - $ref: '#/components/parameters/SearchQ'
      responses:
        '200':
          description: A paginated list of players
          headers:
            RateLimit-Limit: { $ref: '#/components/headers/RateLimit-Limit' }
            RateLimit-Remaining: { $ref: '#/components/headers/RateLimit-Remaining' }
            RateLimit-Reset: { $ref: '#/components/headers/RateLimit-Reset' }
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items: { $ref: '#/components/schemas/Player' }
                  nextCursor:
                    type: string

  /players/{pId}:
    get:
      tags: [Players]
      summary: Get a player by ID
      parameters:
        - $ref: '#/components/parameters/PlayerId'
      responses:
        '200':
          description: Player
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Player' }
        '404': { $ref: '#/components/responses/Problem' }
    post:
      tags: [Players]
      summary: Update player (legacy POST)
      description: Allows updating via POST for compatibility with the slides; PATCH is preferred.
      parameters:
        - $ref: '#/components/parameters/PlayerId'
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PlayerUpdate' }
      responses:
        '200':
          description: Updated player
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Player' }
    patch:
      tags: [Players]
      summary: Update player
      parameters:
        - $ref: '#/components/parameters/PlayerId'
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PlayerUpdate' }
      responses:
        '200':
          description: Updated player
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Player' }

  /players/{pId}/score:
    get:
      tags: [Players]
      summary: Get player's score
      parameters:
        - $ref: '#/components/parameters/PlayerId'
      responses:
        '200':
          description: Score
          content:
            application/json:
              schema:
                type: object
                properties:
                  score: { type: integer }

  /players/{pId}/ranking:
    get:
      tags: [Players]
      summary: Get player's ranking
      parameters:
        - $ref: '#/components/parameters/PlayerId'
      responses:
        '200':
          description: Ranking
          content:
            application/json:
              schema:
                type: object
                properties:
                  ranking: { type: integer }

  /leaderboard:
    get:
      tags: [Players]
      summary: Get leaderboard
      parameters:
        - $ref: '#/components/parameters/PaginationLimit'
        - $ref: '#/components/parameters/PaginationCursor'
      responses:
        '200':
          description: Leaderboard entries
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items: { $ref: '#/components/schemas/LeaderboardEntry' }
                  nextCursor:
                    type: string

  /players/{pId}/matches:
    get:
      tags: [Players]
      summary: List matches for player
      parameters:
        - $ref: '#/components/parameters/PlayerId'
        - $ref: '#/components/parameters/PaginationLimit'
        - $ref: '#/components/parameters/PaginationCursor'
      responses:
        '200':
          description: Player matches
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items: { $ref: '#/components/schemas/MatchSummary' }
                  nextCursor:
                    type: string

  /players/{pId}/matches/{mId}:
    get:
      tags: [Players]
      summary: Get a player's match by ID
      parameters:
        - $ref: '#/components/parameters/PlayerId'
        - $ref: '#/components/parameters/MatchId'
      responses:
        '200':
          description: Match
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Match' }
        '404': { $ref: '#/components/responses/Problem' }

  # MATCHMAKING
  /queue:
    post:
      tags: [Matchmaking]
      summary: Enqueue current player
      responses:
        '202':
          description: Enqueued
    delete:
      tags: [Matchmaking]
      summary: Dequeue current player
      responses:
        '204': { $ref: '#/components/responses/NoContent' }
    get:
      tags: [Matchmaking]
      summary: Queue status for current player
      responses:
        '200':
          description: Queue status
          content:
            application/json:
              schema: { $ref: '#/components/schemas/QueueStatus' }

  # MATCHES
  /matches/{mId}:
    get:
      tags: [Matches]
      summary: Get match by ID
      parameters:
        - $ref: '#/components/parameters/MatchId'
      responses:
        '200':
          description: Match
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Match' }
        '404': { $ref: '#/components/responses/Problem' }

  /matches/{mId}/deck:
    post:
      tags: [Matches]
      summary: Submit deck for a match
      parameters:
        - $ref: '#/components/parameters/MatchId'
      requestBody:
        $ref: '#/components/requestBodies/DeckJson'
      responses:
        '202':
          description: Deck accepted
    get:
      tags: [Matches]
      summary: Get deck submitted for a match
      parameters:
        - $ref: '#/components/parameters/MatchId'
      responses:
        '200':
          description: Deck
          content:
            application/json:
              schema: { $ref: '#/components/schemas/DeckRequest' }

  /matches/{mId}/rounds/{rId}:
    get:
      tags: [Matches]
      summary: Get round details
      parameters:
        - $ref: '#/components/parameters/MatchId'
        - $ref: '#/components/parameters/RoundId'
      responses:
        '200':
          description: Round
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Round' }

  /matches/{mId}/rounds/{rId}/play:
    post:
      tags: [Matches]
      summary: Play a card in a round
      parameters:
        - $ref: '#/components/parameters/MatchId'
        - $ref: '#/components/parameters/RoundId'
      requestBody:
        $ref: '#/components/requestBodies/PlayCardJson'
      responses:
        '202':
          description: Move accepted

  /matches/{mId}/forfeit:
    post:
      tags: [Matches]
      summary: Forfeit a match
      parameters:
        - $ref: '#/components/parameters/MatchId'
      responses:
        '202':
          description: Forfeit accepted

  # Alias for the slide's spelling "forfait"
  /matches/{mId}/forfait:
    post:
      tags: [Matches]
      summary: Forfeit a match (alias /forfait for slides compatibility)
      parameters:
        - $ref: '#/components/parameters/MatchId'
      responses:
        '202':
          description: Forfeit accepted

  # CARD CATALOGUE
  /cards:
    get:
      tags: [Cards]
      summary: List cards
      parameters:
        - $ref: '#/components/parameters/PaginationLimit'
        - $ref: '#/components/parameters/PaginationCursor'
        - $ref: '#/components/parameters/SearchQ'
      responses:
        '200':
          description: A paginated list of cards
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items: { $ref: '#/components/schemas/Card' }
                  nextCursor:
                    type: string
              examples:
                page:
                  $ref: '#/components/examples/CardsPage'

  /cards/{id}:
    get:
      tags: [Cards]
      summary: Get a single card by ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/Id'
      responses:
        '200':
          description: Card
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Card' }
        '404': { $ref: '#/components/responses/Problem' }

  # UTILITIES
  /_meta:
    get:
      tags: [Utilities]
      summary: API metadata and capabilities
      responses:
        '200':
          description: Server capability flags and versions
          content:
            application/json:
              schema:
                type: object
                properties:
                  openapiVersion: { type: string }
                  buildRef: { type: string }
                  features:
                    type: object
                    additionalProperties: { type: boolean }

security:
  - SessionCookie: []
  - BearerAuth: []

# Optional webhooks for future extensibility
webhooks:
  match.status.changed:
    post:
      summary: Notification when a match status changes
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                matchId: { $ref: '#/components/schemas/Id' }
                oldStatus: { type: string }
                newStatus: { type: string }
                at: { type: string, format: date-time }
      responses:
        '200':
          description: Acknowledge
